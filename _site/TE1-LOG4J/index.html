<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Aprovechando la vunlerabilidad log4j - javiercd.es</title>
<meta name="description" content="Practica de seguridad informatica del curso 2021/2022 , en esta se propone analizar , probar y parchear esta vulnerabilidad">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="javiercd.es">
<meta property="og:title" content="Aprovechando la vunlerabilidad log4j">
<meta property="og:url" content="http://localhost:4000/TE1-LOG4J/">


  <meta property="og:description" content="Practica de seguridad informatica del curso 2021/2022 , en esta se propone analizar , probar y parchear esta vulnerabilidad">



  <meta property="og:image" content="http://localhost:4000/assets/images/prueba/logo.png">





  <meta property="article:published_time" content="2022-12-12T00:00:00+01:00">





  

  


<link rel="canonical" href="http://localhost:4000/TE1-LOG4J/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "atlas",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="javiercd.es Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Aprovechando la vunlerabilidad log4j</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="Francisco Javier Cruces Doval" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Francisco Javier Cruces Doval</h3>
    
    
      <p class="author__bio" itemprop="description">
        Administrador de sistemas
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">España</span>
        </li>
      

      

      

      
        <li>
          <a href="mailto:contacto@javiercd.es">
            <meta itemprop="email" content="contacto@javiercd.es" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      
        <li>
          <a href="https://twitter.com/javier_cd_" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/javiercd/" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      
        <li>
          <a href="https://instagram.com/javier_cd_" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Aprovechando la vunlerabilidad log4j">
    <meta itemprop="description" content="Practica de seguridad informatica del curso 2021/2022 , en esta se propone analizar , probar y parchear esta vulnerabilidad">
    <meta itemprop="datePublished" content="December 12, 2022">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Aprovechando la vunlerabilidad log4j
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2022-12-12T00:00:00+01:00">December 12, 2022 </time>&emsp;
          
          
        </p>
        <!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GVDYVWJLRH');
</script>

<p><strong>¿Que es Log4J?</strong></p>

<p>Log4j es una biblioteca de código abierto desarrollada en Java por  Apache Software Foundation que permite a los desarrolladores de software escribir mensajes de registro, cuyo propósito es dejar constancia de una determinada transacción en el tiempo de ejecución. Es ampliamente utilizado por los desarrolladores de aplicaciones web y servidores basados en Java .</p>

<p><strong>¿Que es CVE-2021-44228?</strong></p>

<p>Esta  vulnerabilidad  Log4J de Apache para Java. Esta vulnerabilidad en particular, ha sido registrada con una clasificación CVSS «crítica» máxima de 10, especialmente debido a la capacidad de búsqueda de Log4J, combinada con JNDI (Java Naming and Directory Interface). Este problema está muy extendido porque muchos desarrolladores desconocían  lo peligroso que resulta emplear Log4J sin filtrar las entradas. El riesgo reside es que un atacante puede hacer que una cadena llegue al depurador, cuando es procesada por Log4J, y ejecute código arbitrario  desde una URL remota.</p>

<p>Dado que es una librería incluida en las propias aplicaciones Java, resulta complejo hacernos a la idea del alcance y magnitud del problema. Aquí puedes ver  una relación de las aplicaciones que utilizan Log4J y que en mayor o menor medida están expuestas a esta vulnerabilidad. Esto no excluye a todos los desarrollos a medida existentes que la incluyen →  <a href="https://gist.github.com/SwitHak/b66db3a06c2955a9cb71a8718970c592">productos afectados</a></p>

<p>Se encuentran afectadas las versiones de Apache Log4j comprendidas entre la 2.0-beta9 y la 2.14.1, ambas incluidas. Aquí te dejo este enlace con mas <a href="https://www.reddit.com/r/blueteamsec/comments/rd38z9/log4j_0day_being_exploited/">información</a> , entre ellos  los servicios en la nube como en Steam, Apple iCloud, y aplicaciones como Minecraft son vulnerables. Muchos proyectos de código abierto como el servidor de Minecraft, Paper, Elasticsearch, Zrails, Hadoop, Kafka, Kibana, Solr, Spark, Struts, Tapestry, Wicket, ya han comenzado a parchear el uso de Log4j. Se ha demostrado que simplemente cambiar el nombre de un iPhone desencadena la vulnerabilidad en los servidores de Apple.</p>

<p><strong>Preparación del entorno</strong></p>

<p>Para simular un escenario real vamos a tener 2 maquinas virtuales , un Ubuntu que simulara ser un servidor vulnerable y un Kali que sera el atacante .</p>

<p>Empezamos con Ubuntu instalándonos la utilidad git ya que posteriormente descargaremos una herramienta para tener  un servidor vulnerable :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.001.png" alt="" /></p>

<p>También instalaremos docker</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.002.png" alt="" /></p>

<p>Ahora clonaremos este repositorio donde descargaremos un servicio vulnerable :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.003.png" alt="" /></p>

<p>Comprobamos la ruta de la carpeta</p>

<p>Vamos a cargala usando docker:</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.004.png" alt="" /></p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.005.png" alt="" /></p>

<p>Una vez tengamos la siguiente salida ya abríamos cargado el programa , que es un apache vulnerable (Spring) :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.006.png" alt="" /></p>

<p>Este se quedara escuchando a través del puerto 8080 así que nosotros vamos a irnos a nuestro kali a descargarnos el nuestro exploit :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.007.png" alt="" /></p>

<p>Como nos hemos descargado el archivo comprimido vamos a descomprimirlo :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.008.png" alt="" /></p>

<p>Vemos que se nos ha creado dos archivos .jar , vamos a ejecutarlos :</p>

<p>Los parámetros -i (ip local de la maquina kali ) , -p (puerto por el que escucha )</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.009.png" alt="" /></p>

<p>Con esta herramienta acabamos de hacer un servidor LDAP y HTTP maliciosos que van a recibir la información de la maquina vulnerable cuando le enviemos comandos . Todo esto hemos de hacerlo en maquinas virtuales ya que estamos utilizando código de terceros y no sabemos si tiene malware dentro .</p>

<p>Ahora ejecutaremos un comando  en el cual podremos hacer cualquier cosa en el servidor , tiene la siguiente sintaxis  :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.010.png" alt="" /></p>

<p>En función del comando que pongamos codificado en base64 hará diferente cosas , este comando hace que cree un archivo en el servidor . Vamos a comprobarlo si se ha creado en el servidor :<img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.011.jpeg" alt="" /></p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.012.png" alt="" /></p>

<p>Ahora usando un codificador en base64 vamos a cambiar el comando por uno que haga una carpeta llamada RAUL .</p>

<p>Ahora vamos a cambiar el comando</p>

<p>:<img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.013.png" alt="" /></p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.014.png" alt="" /></p>

<p>Y a comprobar si se ha creado la carpeta :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.015.png" alt="" /></p>

<p>He aquí el gran problema de esta vulnerabilidad que podemos ejecutar comandos teniendo el control total sobre los servidores ,  pudiendo hacer los que nos de la gana , ejecutar malware , robar información …</p>

<p><strong>Como verificar si nuestro servidor es vulnerable</strong></p>

<p>Para comprobar si tenemos esta vulnerabilidad vamos a ejecutar este scrpit de github que se ha echo bastante popular :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.016.png" alt="" /></p>

<p>Si nos fijamos nos tira 3 advertencias :</p>

<p>-Tenemos java instalado</p>

<p>-Ha encontrado 2 aplicaciones con el nombre log4j</p>

<p>-El scrpit no tiene el 100% de la razón de si somos o no vulnerables Vamos a ver que nos dice <strong>OpenVas</strong> :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.017.png" alt="" /></p>

<p>Efectivamente somos vulnerable a esta vulnerabilidad así que vamos a solucionarla .</p>

<p>Tan bien le he echo un escaneo a la red de mi casa para ver si algún dispositivo es vulnerable a esta (La red 43.X es la red de mi móvil y 1.X de mi casa):</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.018.png" alt="" /></p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.019.png" alt="" /></p>

<p>Mi red de  casa no ha sido afectada por esta vulnerabilidad .</p>

<p><strong>Solución a la vulnerabilidad</strong></p>

<p>Hay varias formas de solucionar el problema , una  seria actualizar a la versión 2.16.0 y otra  seria cambiar una propiedad del sistema LOG4J_FORMAT_MSG_NO_LOOKUPS en true  .En mi caso ejecutare un parche de github :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.020.png" alt="" /></p>

<p>Nos ponemos en la ruta y lo compilamos con maven :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.021.png" alt="" /></p>

<p>Ahora nos ponemos en la ruta y especificada y lo ejecutamos :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.022.png" alt="" /></p>

<p>Ahora reiniciamos el servicio y pasare el escáner de nuevo  :</p>

<p><img src="/assets/images/seguridad/log4j/Aspose.Words.4e0f0bbb-fd6c-4612-89b5-8d883b26fa27.023.png" alt="" /></p>

<p>Como vemos se ha solucionado la vulnerabilidad gracias al parche , pero hay métodos mas sencillos como declarar una variable de entorno , pero esto dependerá de la versión de la librería y java que tengamos instalada .</p>

<p><strong>Bibliografía</strong></p>

<p>-<a href="https://github.com/christophetd/log4shell-vulnerable-app">Servidor vulnerable</a></p>

<p>-<a href="https://blog.segu-info.com.ar/2021/12/log4shell-vulnerabilidad-critica-con.html">Información sobre la vulnerabilidad</a></p>

<p>-<a href="https://stackoverflow.com/questions/70360237/log4j-vulnerability-cve-2021-44228-in-spring-boot-fix-bugs-in-log4j-2-15-0">Solución a la vulnerabilidad</a> – <a href="https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot">Link2</a> – <a href="https://github.com/corretto/hotpatch-for-apache-log4j2">Parche script </a>-<a href="https://www.youtube.com/watch?v=qMHeil1ekCk&amp;list=LL&amp;index=1&amp;t=2s&amp;ab_channel=CiberseguridadParaTodos-DavidPereira">Video sobre el escecnario </a></p>

<p>-<a href="https://www.youtube.com/watch?v=ppKI00xCZr8&amp;ab_channel=IonutConstantin">Fix en windows server</a></p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#smr" class="page__taxonomy-item" rel="tag">SMR</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#seguridad" class="page__taxonomy-item" rel="tag">Seguridad</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2022-12-12T00:00:00+01:00">December 12, 2022</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/proyecto_activedirectory_ubuntu/" class="pagination--pager" title="Instalacion y configuracion Active Directory en Ubuntu Server 20.04 LTS
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 atlas</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
